name: –û–±—Ä–∞–±–æ—Ç–∫–∞ Markdown —Ñ–∞–π–ª–æ–≤ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

on:
  schedule:
    - cron: '0 0 * * 1'  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å workflow –≤—Ä—É—á–Ω—É—é

env:
  SOURCE_OWNER: 'ciscoheat'
  SOURCE_REPO: 'superforms-web'
  SOURCE_BRANCH: 'main'

jobs:
  process-markdown:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout –Ω–∞—à–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
        
      - name: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
        run: |
          mkdir -p docs
          mkdir -p /tmp/source-repo
          mkdir -p /tmp/md_processing

      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        run: |
          echo "üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
          git clone https://github.com/${{ env.SOURCE_OWNER }}/${{ env.SOURCE_REPO }}.git --branch ${{ env.SOURCE_BRANCH }} --single-branch /tmp/source-repo
          echo "‚úì –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É—Å–ø–µ—à–Ω–æ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω"

      - name: –û–±—Ä–∞–±–æ—Ç–∫–∞ Markdown —Ñ–∞–π–ª–æ–≤
        run: |
          echo "üîç –ü–æ–∏—Å–∫ Markdown —Ñ–∞–π–ª–æ–≤ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏..."
          
          # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ markdown —Ñ–∞–π–ª—ã –≤ src –∏ –ø–æ–¥–ø–∞–ø–∫–∞—Ö –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
          find /tmp/source-repo/src -type f -name "*.md" | while read file; do
            # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—É—Ç–∏
            # –í—ã—Ä–µ–∑–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å /tmp/source-repo/src/
            relpath=${file#"/tmp/source-repo/src/"}
            # –ó–∞–º–µ–Ω—è–µ–º —Å–ª—ç—à–∏ –Ω–∞ –¥–µ—Ñ–∏—Å—ã
            filename=$(echo "$relpath" | sed 's/\//-/g')
            
            echo "‚öôÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞: $file"
            echo "   ‚Üí –ë—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫: $filename"
            
            # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            temp_file="/tmp/md_processing/$filename"
            
            # –£–¥–∞–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç–æ–≤—ã–π –±–ª–æ–∫ –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
            sed '/^<script lang="ts">$/,/^<\/script>$/d' "$file" > "$temp_file"
            
            # –ö–æ–ø–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ —Ü–µ–ª–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            cp "$temp_file" "docs/$filename"
            
            echo "‚úÖ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫: docs/$filename"
          done
          
      - name: –ö–æ–º–º–∏—Ç –∏ –ø—É—à –∏–∑–º–µ–Ω–µ–Ω–∏–π
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if [[ -n $(git status -s docs/) ]]; then
            echo "üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
            git add docs/
            git commit -m "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö Markdown —Ñ–∞–π–ª–æ–≤ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
            git push origin HEAD:main
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã"
          else
            echo "üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç, –∫–æ–º–º–∏—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
          fi
          
      - name: –û—á–∏—Å—Ç–∫–∞
        if: always()
        run: |
          # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          rm -rf /tmp/source-repo
          rm -rf /tmp/md_processing
          echo "üßπ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã"
